# tabs/tab_bookstore_demo.py
import streamlit as st
import pandas as pd
from knn_dynamic import get_dynamic_knn
#from utils import render_aligned_image
import random

def load_books_from_csv(csv_path: str) -> list:
    """Charge les livres depuis le CSV avec toutes les corrections"""
    df = pd.read_csv(csv_path)
    catalogue_df = df.drop_duplicates(subset="ISBN")
    books = []

    for _, row in catalogue_df.iterrows():
        
        safe_year: int = 2000 
        year_value = row.get('api_first_publish_year')
        if not (pd.isna(year_value) or year_value == '' or str(year_value) == 'nan'):
            try:
                safe_year = int(float(year_value))
            except (ValueError, TypeError):
                safe_year = 2000

        # ‚úÖ CORRECTION 2: Description propre
        description = row.get('Description', '')
        if pd.isna(description) or str(description) == 'nan':
            description = ''

        books.append({
            'title': row.get('Book-Title', ''),
            'author_string': row.get('Book-Author', ''),
            'subject_string': row.get('subject_string_final', ''), 
            'description': str(description).strip(), 
            'publisher_string': row.get('api_publisher_string', ''), 
            'first_publish_year': safe_year,  
            'isbn': row.get('ISBN', ''),
            'cover_url': row.get('api_cover_url', ''),
            'key': row.get('key', '')
        })
    return books


def show_bookstore_demo():
    """Onglet pour les recommandations dynamiques avec KNN"""
    
    st.header("Recommandations par livre")
    st.markdown("### Syst√®me de recommandation bas√© sur l'API Open Library")
    
    try:
        books_data = load_books_from_csv("data/catalog_clean.csv")

        knn = get_dynamic_knn()
        knn.books_data = books_data

        if len(books_data) >= 5:
            knn._fit_model()

        stats={
            'total_books': len(books_data),
            'unique_authors': len(set(book.get('author_string', '') for book in books_data)),
            'is_model_fitted': len(books_data) > 0
        }
        
        # Afficher les statistiques en colonnes
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric("üìö Livres", stats['total_books'])
        with col2:
            st.metric("üë• Auteurs", stats['unique_authors'])
        with col3:
            st.metric("ü§ñ Mod√®le", "‚úÖ" if stats['is_model_fitted'] else "‚ùå")
        
        if stats['total_books'] > 0:
            st.write(f"**P√©riode:** {stats.get('year_range', 'N/A')}")
        
        st.divider()
        
        # Interface simplifi√©e pour libraire
        st.subheader("üîç Recherche de recommandations")

        
        # Interface de recommandation principale
        if stats['total_books'] > 0:
            book_titles = [book['title'] for book in knn.books_data]
            
            # Recherche par titre
            col1, col2 = st.columns([3, 1])
            with col1:
                selected_book = st.selectbox(
                    "üìñ Choisir un livre :",
                    options=book_titles,
                    help="Tapez pour rechercher ou s√©lectionnez dans la liste"
                )
            
            with col2:
                n_recommendations = st.selectbox(
                    "Nombre de suggestions :",
                    options=[3, 5, 8, 10],
                    index=1
                )
            
            if selected_book:
                st.subheader("üìñ Livre de r√©f√©rence pour la recommendation")
                
                # Trouver le livre dans les donn√©es KNN
                reference_book = None
                for book in knn.books_data:
                    if book['title'] == selected_book:
                        reference_book = book
                        break
                
                if reference_book:
                    # Affichage optimis√© pour le libraire
                    col1, col2, col3 = st.columns([1, 2, 1])
                    
                    with col1:
                        # Couverture
                        cover_url = reference_book.get("cover_url")
                        if cover_url and str(cover_url) != 'nan' and cover_url.startswith('http'):
                            st.image(cover_url, width=120, caption="Couverture")
                        else:
                            st.info("üì∑ Pas de couverture")
                    
                    with col2:
                        # Informations principales pour le libraire
                        st.markdown(f"**üìñ Titre :** {reference_book.get('title', 'N/A')}")
                        st.markdown(f"**‚úçÔ∏è Auteur :** {reference_book.get('author_string', 'N/A')}")
                        st.markdown(f"**üìÖ Ann√©e :** {reference_book.get('first_publish_year', 'N/A')}")
                        
                        # Genres - important pour les recommandations
                        subjects = reference_book.get('subject_string', 'N/A')
                        if len(subjects) > 80:
                            subjects = subjects[:80] + "..."
                        st.markdown(f"**üè∑Ô∏è Genres :** {subjects}")
                        
                        # √âditeur si disponible (utile pour le libraire)
                        publisher = reference_book.get('publisher_string')
                        if publisher and str(publisher) != 'nan' and publisher.strip():
                            if len(publisher) > 40:
                                publisher = publisher[:40] + "..."
                            st.markdown(f"**üè¢ √âditeur :** {publisher}")
                    
                    with col3:
                        # Informations business pour le libraire
                        st.markdown("**üíº Info Libraire :**")
                        
                        # Simulation stock du livre de r√©f√©rence
                        ref_stock = random.choice([
                            ("‚úÖ En stock", "success"),
                            ("‚ö†Ô∏è Stock faible", "warning"), 
                            ("‚ùå √âpuis√©", "error")
                        ])
                        st.markdown(f"**Stock :** {ref_stock[0]}")
                        
                        # Prix simul√©
                        ref_price = random.randint(15, 28)
                        st.markdown(f"**Prix :** {ref_price}‚Ç¨")
                        
                        # Genre principal pour cibler les recommandations
                        if reference_book.get('subject_string'):
                            main_genre = reference_book['subject_string'].split(',')[0].strip()
                            st.markdown(f"**üéØ Genre principal :** {main_genre}")
                    
                    # Description courte si disponible (utile pour argumenter)
                    description = reference_book.get('description', '')
                    if description and str(description) != 'nan' and len(str(description).strip()) > 10:
                        st.markdown("**üìù Synopsis :**")
                        desc_text = str(description)
                        if len(desc_text) > 500:
                            desc_text = desc_text[:500] + "..."
                        st.markdown(f"*{desc_text}*")
                
                # S√©parateur visuel
                st.markdown("---")
            
            if st.button("üéØ Obtenir les recommandations", key="get_bookstore_recs", type="primary"):
                if selected_book:
                    with st.spinner("ü§î Recherche des meilleures recommandations..."):
                        recommendations = knn.get_recommendations(selected_book, n_recommendations)
                        
                        if recommendations:
                            # Interface adapt√©e libraire
                            st.success(f"‚ú® Voici {len(recommendations)} excellentes suggestions pour votre client !")
                            
                            # Affichage des recommandations en format "vitrine"
                            for i, rec in enumerate(recommendations, 1):
                                with st.expander(f"üìö Suggestion #{i}: {rec['title']} ‚≠ê {rec['similarity_score']:.0%} de similarit√©"):
                                    
                                    col1, col2, col3 = st.columns([1, 2, 1])
                                    
                                    with col1:
                                        if rec.get('cover_url'):
                                            st.image(rec['cover_url'], width=120)
                                    
                                    with col2:
                                        st.markdown(f"**üìñ Titre :** {rec['title']}")
                                        st.markdown(f"**‚úçÔ∏è Auteur :** {rec['author_string']}")
                                        st.markdown(f"**üìÖ Ann√©e :** {rec['first_publish_year']}")
                                        
                                        # Points de vente pour le libraire
                                        subjects = rec['subject_string'][:100]
                                        if subjects:
                                            st.markdown(f"**üè∑Ô∏è Genres :** {subjects}...")
                                        
                                        # Score de similarit√© pour le libraire
                                        similarity_percent = rec['similarity_score'] * 100
                                        st.progress(rec['similarity_score'], 
                                                  text=f"Similarit√©: {similarity_percent:.0f}%")
                                    
                                    st.markdown("---")  # S√©parateur
                                    
                                    # R√©sum√©/Description compl√®te
                                    description = rec.get('description', '')
                                    if description and str(description) != 'nan' and len(str(description).strip()) > 10:
                                        st.markdown("**üìñ R√©sum√© du livre :**")
                                        desc_text = str(description).strip()
                                        
                                        # G√©rer la longueur : affichage progressif
                                        if len(desc_text) > 300:
                                            # Affichage avec option "Voir plus"
                                            short_desc = desc_text[:300] + "..."
                                            
                                            # Utiliser l'expander pour le texte long
                                            st.markdown(f"*{short_desc}*")
                                            
                                            if st.button("üìö Voir le r√©sum√© complet", key=f"full_desc_{i}"):
                                                st.markdown("**üìñ R√©sum√© complet :**")
                                                st.markdown(f"*{desc_text}*")
                                        else:
                                            # Description courte : affichage direct
                                            st.markdown(f"*{desc_text}*")
                                    
                                    elif rec.get('subject_string'):
                                        # Si pas de vraie description, utiliser les sujets comme description de fallback
                                        st.markdown("**üìñ R√©sum√© du livre :**")
                                        subjects_desc = f"Livre de genre {rec['subject_string']} par {rec['author_string']}"
                                        if rec.get('first_publish_year'):
                                            subjects_desc += f", publi√© en {rec['first_publish_year']}"
                                        subjects_desc += "."
                                        st.markdown(f"*{subjects_desc}*")
                                    
                                    else:
                                        # Aucune description disponible
                                        st.markdown("**üìñ R√©sum√© du livre :**")
                                        st.info("üìù R√©sum√© non disponible dans la base de donn√©es")
                                        
                                        # Suggestion pour le libraire
                                        st.markdown("üí° **Conseil libraire :** Consultez la quatri√®me de couverture ou votre fournisseur pour plus d'informations")

                                    
                                    with col3:
                                        # Outils pour le libraire
                                        st.markdown("**üíº Infos pratiques :**")
                                        
                                        # Simulation de disponibilit√©
                                        stock_status = random.choice([
                                            ("‚úÖ En stock", "success"),
                                            ("‚ö†Ô∏è Stock faible", "warning"), 
                                            ("‚ùå √âpuis√©", "error"),
                                            ("üì¶ Sur commande", "info")
                                        ])
                                        st.markdown(f"**Stock :** {stock_status[0]}")
                                        
                                        # Prix simul√©
                                        price = random.randint(12, 25)
                                        st.markdown(f"**Prix :** {price}‚Ç¨")
                                        
                                        if st.button("üîç D√©tails", key=f"details_{i}"):
                                            st.info("Fonctionnalit√© : Voir fiche produit compl√®te")
                            
                            # Statistiques de session pour le libraire
                            st.divider()
                            with st.expander("üìä Statistiques de la session (pour le libraire)"):
                                col1, col2, col3 = st.columns(3)
                                with col1:
                                    st.metric("üéØ Recommandations g√©n√©r√©es", len(recommendations))
                                with col2:
                                    avg_similarity = sum(r['similarity_score'] for r in recommendations) / len(recommendations)
                                    st.metric("‚≠ê Pertinence moyenne", f"{avg_similarity:.0%}")
                                with col3:
                                    available_books = sum(1 for _ in recommendations if random.choice([True, True, False]))
                                    st.metric("üì¶ Livres disponibles", f"{available_books}/{len(recommendations)}")
                        
                        else:
                            st.warning("üòî Aucune recommandation trouv√©e pour ce livre")
                            st.info("üí° Conseil : Essayez d'alimenter le dataset avec plus de livres du m√™me genre")
                
                else:
                    st.warning("‚ö†Ô∏è Veuillez s√©lectionner un livre")
        
        else:
            # Interface si pas de dataset
            st.info("üìö **Dataset vide** - Alimentez d'abord le syst√®me via l'onglet 'Dataset Builder'")
            
            st.markdown("""
            ### üèóÔ∏è Configuration initiale pour librairie
            
            **Pour utiliser ce syst√®me dans votre librairie :**
            
            1. **Construisez votre catalogue** via l'onglet "Dataset Builder"
            2. **Choisissez vos genres principaux** (fantasy, policier, romance, etc.)
            3. **Lancez la construction** (une seule fois, 30-60 minutes)
            4. **Utilisez le syst√®me** quotidiennement pour conseiller vos clients
            
            """)
        
        # Section informative pour la pr√©sentation
        with st.expander("‚ÑπÔ∏è √Ä propos de ce syst√®me (pour la pr√©sentation)"):
            st.markdown("""
            ### üéØ Objectif du projet
            
            **Simuler un syst√®me de recommandation r√©aliste pour librairie** en utilisant :
            - L'API Open Library (gratuite) comme source de donn√©es
            - Un algorithme KNN pour calculer les similarit√©s
            - Une interface adapt√©e aux besoins des libraires
            
            ### üîß Adaptations pour le contexte r√©el
            
            **Dans une vraie librairie, ce syst√®me pourrait √™tre connect√© √† :**
            - üì¶ Syst√®me de gestion des stocks
            - üí∞ Base de donn√©es des prix
            - üìä Historique des ventes
            - üë• Profils clients et historique d'achats
            
            ### üí° Valeur ajout√©e
            
            - **Pour le client :** D√©couverte personnalis√©e, gain de temps
            - **Pour le libraire :** Outil d'aide √† la vente, expertise renforc√©e
            - **Pour la librairie :** Augmentation des ventes, fid√©lisation client
            """)
    
    except Exception as e:
        st.error(f"‚ùå Erreur dans l'interface librairie: {str(e)}")
        st.info("V√©rifiez que le dataset est construit et que tous les fichiers sont pr√©sents.")